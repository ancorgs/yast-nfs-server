/**
 * Module:
 *   NFS server configuration
 *
 * Summary:
 *   Testsuite
 *
 * Authors:
 *   Martin Vidner <mvidner@suse.cz>
 *
 * $Id$
 */
{
    include "testsuite.ycp";
    import "NfsServer";
    import "Report";

    NfsServer::write_only = false;
    Report::DisplayErrors (false, 0);

    map service_on = $[
	"start": [ "3", "5"],
	"stop":	 [ "3", "5"],
	];
    map service_off = $[
	"start": [],
	"stop":	 [],
	];
    list exports = [$["allowed":["proj*.local.domain(rw)"],
		      "mountpoint":"/projects"],
		    $["allowed":["*.local.domain(ro)", "@trusted(rw)"],
		      "mountpoint":"/usr"],
		    $["allowed":["(ro,insecure,all_squash)"],
		      "mountpoint":"/pub"]];
    map READ = $[
	// Runlevel:
	"init": $[
	    "scripts": $[
		"exists": true,
		"runlevel": $[
		    "portmap": service_on,
		    "nfsserver": service_on,
		    ],
		// their contents is not important for ServiceAdjust
		"comment": $[
		    "portmap": $[],
		    "nfsserver": $[],
		    ],
		],
	    ],
    /*
	// targetpkg:
	"targetpkg": $[
	    // autofs
	    "installed": true,
	    ],
    */
	// NfsServer itself:
	"etc": $[
	    "exports": exports,
	    "sysconfig": $[
		],
	    ],
	"target": $[
	    "dir": nil,		// pretend none exist
	    ]
	];

    // pretend nfslock does not exist
    //   not used
    map READ2 = READ;
    READ2["init","scripts","exists"] = false;

    // services portmap & nfsserver are stopped
    map READ3 = READ;
    READ3["init","scripts","runlevel","portmap"]   = service_off;
    READ3["init","scripts","runlevel","nfsserver"] = service_off;

    map WRITE = $[
	];

    // not used
    map WRITE_KO = $[
	"etc": $[
	    "exports": false,
	    ],
	];

    map EXECUTE = $[
	"target": $[
	    "bash_output": $[
		"exit": 0,
		"stdout": "",
		"stderr": "",
		],
	    "mkdir": true,
	    ],
	];

    // nfsserver and portmap are running
    DUMP ("\nRead  - services are running\n");
    TEST (``(NfsServer::Read ()), [READ, WRITE, EXECUTE], nil);
    DUMP ("\nWrite - services will be stopped\n");
    // Stop services!
    NfsServer::start = false;
    // And Write
    TEST (``(NfsServer::Write ()), [READ, WRITE, EXECUTE], nil);

    // nfsserver and portmap are running
    DUMP ("\nRead  - services are running\n");
    TEST (``(NfsServer::Read ()), [READ, WRITE, EXECUTE], nil);
    DUMP ("\nWrite - services are running\n");
    // Start services (nfsserver)
    NfsServer::start = true;
    // And Write
    TEST (``(NfsServer::Write ()), [READ, WRITE, EXECUTE], nil);

    // nfsserver and portmap are stopped
    DUMP ("\nRead  - services are stopped\n");
    TEST (``(NfsServer::Read ()), [READ3, WRITE, EXECUTE], nil);
    DUMP ("\nWrite - services will be stopped\n");
    // Leave services stopped
    NfsServer::start = false;
    // And Write
    TEST (``(NfsServer::Write ()), [READ3, WRITE, EXECUTE], nil);

    // nfsserver and portmap are stopped
    DUMP ("\nRead  - services are stopped\n");
    TEST (``(NfsServer::Read ()), [READ3, WRITE, EXECUTE], nil);
    DUMP ("\nWrite - services will be started\n");
    // Start services
    NfsServer::start = true;
    // And Write
    TEST (``(NfsServer::Write ()), [READ3, WRITE, EXECUTE], nil);
}
